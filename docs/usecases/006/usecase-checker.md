# Usecase êµ¬í˜„ ìƒíƒœ ì ê²€ ë³´ê³ ì„œ

- **ì ê²€ ì¼ì‹œ**: 2025-10-17
- **ì ê²€ ëŒ€ìƒ ë¬¸ì„œ**:
  - spec: docs\usecases\006\spec.md
  - ê´€ë ¨ êµ¬í˜„: src\features\chat-room\backend (ë¦¬ì•¡ì…˜ ê¸°ëŠ¥ì´ chat-room ê¸°ëŠ¥ì— í†µí•©ë¨)

---

## âœ… êµ¬í˜„ ì™„ë£Œëœ ê¸°ëŠ¥

| ê¸°ëŠ¥/í˜ì´ì§€ | ê´€ë ¨ ì½”ë“œ íŒŒì¼ | í”„ë¡œë•ì…˜ ë ˆë²¨ ì¶©ì¡± ì—¬ë¶€ | ë¹„ê³  |
|---|---|---|---|
| **API - ë¦¬ì•¡ì…˜ í† ê¸€** | `src/features/chat-room/backend/route.ts:173-228` | âš ï¸ ë¶€ë¶„ ì¶©ì¡± | POST /api/messages/:messageId/reactions ì—”ë“œí¬ì¸íŠ¸ ì¡´ì¬, í† ê¸€ ë™ì‘ êµ¬í˜„ë¨ |
| **ì„œë¹„ìŠ¤ ë¡œì§ - ë¦¬ì•¡ì…˜ í† ê¸€** | `src/features/chat-room/backend/service.ts:489-614` | âš ï¸ ë¶€ë¶„ ì¶©ì¡± | ê¶Œí•œ í™•ì¸, ì‚­ì œ ë©”ì‹œì§€ ì²´í¬, í† ê¸€ ë¡œì§ êµ¬í˜„ë¨ |
| **ìŠ¤í‚¤ë§ˆ ì •ì˜** | `src/features/chat-room/backend/schema.ts:1-161` | âœ… ì™„ì „ ì¶©ì¡± | Zod ìŠ¤í‚¤ë§ˆ ì •ì˜ ì™„ë£Œ, Reaction/ToggleReactionRequest/ToggleReactionResponse ì •ì˜ë¨ |
| **DB í…Œì´ë¸” - message_reactions** | `supabase/migrations/0002_define_chat_schema.sql:141-149` | âš ï¸ ë¶€ë¶„ ì¶©ì¡± | ë³µí•© PK (message_id, user_id, reaction_type) ì •ì˜ë¨, check constraint ì¡´ì¬ |
| **ì—ëŸ¬ ì½”ë“œ ì •ì˜** | `src/features/chat-room/backend/error.ts:1-27` | âœ… ì™„ì „ ì¶©ì¡± | chatRoomErrorCodesì— í•„ìš”í•œ ì—ëŸ¬ íƒ€ì… ì •ì˜ë¨ |
| **í”„ë¡ íŠ¸ì—”ë“œ í›…** | `src/features/chat-room/hooks/useToggleReaction.ts` | âš ï¸ ë¶€ë¶„ ì¶©ì¡± | React Query mutation ì‚¬ìš©, ë‚™ê´€ì  UI ì—…ë°ì´íŠ¸ êµ¬í˜„ |
| **UI ì»´í¬ë„ŒíŠ¸** | `src/features/chat-room/components/message-bubble.tsx:106-125` | âš ï¸ ë¶€ë¶„ ì¶©ì¡± | ë¦¬ì•¡ì…˜ ì•„ì´ì½˜ í‘œì‹œ, í´ë¦­ í•¸ë“¤ëŸ¬ êµ¬í˜„, ì‹œê°ì  í”¼ë“œë°± ì œê³µ |
| **DTO ì¬ë…¸ì¶œ** | `src/features/chat-room/lib/dto.ts` | âœ… ì™„ì „ ì¶©ì¡± | ë°±ì—”ë“œ ìŠ¤í‚¤ë§ˆë¥¼ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ export |

---

## âŒ êµ¬í˜„ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ë³´ì™„ì´ í•„ìš”í•œ ê¸°ëŠ¥

| ê¸°ëŠ¥/í˜ì´ì§€ | ìƒíƒœ | êµ¬í˜„ ê³„íš |
|---|---|---|
| **DELETE ì—”ë“œí¬ì¸íŠ¸** | âŒ ë¯¸êµ¬í˜„ | spec.md:254-272ì— ì •ì˜ëœ `DELETE /api/messages/{messageId}/reactions/{reactionType}` ì—”ë“œí¬ì¸íŠ¸ ì—†ìŒ. í˜„ì¬ëŠ” POSTë¡œ í† ê¸€ ë°©ì‹ë§Œ êµ¬í˜„ |
| **GET ë¦¬ì•¡ì…˜ ëª©ë¡ ì¡°íšŒ** | âŒ ë¯¸êµ¬í˜„ | spec.md:274-297ì— ì •ì˜ëœ `GET /api/messages/{messageId}/reactions` ì—”ë“œí¬ì¸íŠ¸ ì—†ìŒ. ë¦¬ì•¡ì…˜ì„ ì¶”ê°€í•œ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ ë¶ˆê°€ |
| **í…ŒìŠ¤íŠ¸ ì½”ë“œ** | âŒ ì™„ì „ ë¯¸êµ¬í˜„ | ë‹¨ìœ„ í…ŒìŠ¤íŠ¸/í†µí•© í…ŒìŠ¤íŠ¸ íŒŒì¼ ì—†ìŒ (*.test.ts, *.test.tsx, *.spec.ts ë“±) |
| **DB ì¸ë±ìŠ¤ ìµœì í™”** | âš ï¸ ë¶€ë¶„ êµ¬í˜„ | spec.md:192-193ì— ì •ì˜ëœ `idx_message_reactions_message`, `idx_message_reactions_user` ì¸ë±ìŠ¤ ë¯¸ìƒì„± |
| **ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ UI** | âš ï¸ ë¶ˆëª…í™• | ì‚­ì œëœ ë©”ì‹œì§€ì— ë¦¬ì•¡ì…˜ ì‹œë„, ê¶Œí•œ ì—†ëŠ” ì‚¬ìš©ìì˜ ë¦¬ì•¡ì…˜ ì‹œë„ ë“± ì—ëŸ¬ ì¼€ì´ìŠ¤ì— ëŒ€í•œ ëª…ì‹œì  UI í”¼ë“œë°± ë¡œì§ ë¶ˆëª…í™• |
| **ë¦¬ì•¡ì…˜ ì‚¬ìš©ì ëª©ë¡ ëª¨ë‹¬** | âŒ ë¯¸êµ¬í˜„ | spec.md:166-169 (UX5)ì— ì •ì˜ëœ ë¦¬ì•¡ì…˜ ì¹´ìš´íŠ¸ í´ë¦­ ì‹œ ì‚¬ìš©ì ëª©ë¡ í‘œì‹œ ê¸°ëŠ¥ ì—†ìŒ |
| **ë‚™ê´€ì  UI ë¡¤ë°±** | âš ï¸ ë¶ˆëª…í™• | useToggleReactionì—ì„œ onError í•¸ë“¤ëŸ¬ ë¯¸êµ¬í˜„, ì‹¤íŒ¨ ì‹œ ì´ì „ ìƒíƒœ ë³µì› ë¡œì§ ì—†ìŒ |
| **ì¤‘ë³µ í´ë¦­ ë°©ì§€** | âš ï¸ ë¶ˆëª…í™• | í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìš”ì²­ ì¤‘ ìƒíƒœ ê´€ë¦¬ ë° ë²„íŠ¼ ë¹„í™œì„±í™” ë¡œì§ ë¶ˆëª…í™• |
| **ì£¼ì„ ë° ë¬¸ì„œí™”** | âš ï¸ ë¶€ì¡± | ì£¼ìš” í•¨ìˆ˜ì— JSDoc ì£¼ì„ ë¶€ì¡±, íŠ¹íˆ toggleReaction ì„œë¹„ìŠ¤ í•¨ìˆ˜ ë“± |

---

## ğŸ“ ì¢…í•© ì˜ê²¬

### ê¸ì •ì  ì¸¡ë©´

1. **í•µì‹¬ ê¸°ëŠ¥ êµ¬í˜„ ì™„ë£Œ**: ë¦¬ì•¡ì…˜ í† ê¸€ì˜ í•µì‹¬ ë¡œì§(ì¶”ê°€/ì œê±°)ì´ ë°±ì—”ë“œì— ì •ìƒ êµ¬í˜„ë˜ì–´ ìˆìœ¼ë©°, í† ê¸€ ë°©ì‹ìœ¼ë¡œ ë©±ë“±ì„±ì´ ë³´ì¥ë©ë‹ˆë‹¤.
2. **ê¶Œí•œ ê²€ì¦ ì² ì €**: ì±„íŒ…ë°© ë©¤ë²„ì‹­ í™•ì¸, ì‚­ì œëœ ë©”ì‹œì§€ í™•ì¸ ë“± í•„ìˆ˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
3. **íƒ€ì… ì•ˆì •ì„±**: Zod ìŠ¤í‚¤ë§ˆë¡œ ìš”ì²­/ì‘ë‹µ ê²€ì¦ì´ ì´ë£¨ì–´ì§€ë©°, TypeScriptë¡œ íƒ€ì… ì•ˆì •ì„±ì„ í™•ë³´í•˜ê³  ìˆìŠµë‹ˆë‹¤.
4. **UI ì—°ë™**: React Queryë¥¼ ì‚¬ìš©í•œ í”„ë¡ íŠ¸ì—”ë“œ í›…ê³¼ MessageBubble ì»´í¬ë„ŒíŠ¸ì—ì„œ ë¦¬ì•¡ì…˜ í‘œì‹œ ë° í´ë¦­ ì´ë²¤íŠ¸ê°€ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

### ê°œì„  í•„ìš” ì‚¬í•­

1. **í”„ë¡œë•ì…˜ ë ˆë²¨ ë¯¸ë‹¬**:
   - **í…ŒìŠ¤íŠ¸ ì½”ë“œ ì „ë¬´**: ë‹¨ìœ„/í†µí•© í…ŒìŠ¤íŠ¸ê°€ ì „í˜€ ì—†ì–´ í”„ë¡œë•ì…˜ ë°°í¬ ì‹œ ë¦¬ìŠ¤í¬ê°€ í½ë‹ˆë‹¤.
   - **ì—ëŸ¬ í•¸ë“¤ë§ ë¶ˆì™„ì „**: í”„ë¡ íŠ¸ì—”ë“œì—ì„œ onError í•¸ë“¤ëŸ¬, ë‚™ê´€ì  UI ë¡¤ë°±, ì‚¬ìš©ì í”¼ë“œë°± ë©”ì‹œì§€ ë“±ì´ ëª…í™•íˆ êµ¬í˜„ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.

2. **Spec ë¶ˆì¼ì¹˜**:
   - **DELETE ì—”ë“œí¬ì¸íŠ¸ ë¯¸êµ¬í˜„**: specì—ëŠ” ë³„ë„ì˜ DELETE ì—”ë“œí¬ì¸íŠ¸ê°€ ì •ì˜ë˜ì–´ ìˆìœ¼ë‚˜ ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” POST í† ê¸€ë§Œ ì œê³µí•©ë‹ˆë‹¤.
   - **GET ë¦¬ì•¡ì…˜ ëª©ë¡ ì¡°íšŒ ë¯¸êµ¬í˜„**: ë¦¬ì•¡ì…˜ì„ ëˆ„ë¥¸ ì‚¬ìš©ì ëª©ë¡ì„ ì¡°íšŒí•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.

3. **ì„±ëŠ¥ ìµœì í™” ë¶€ì¡±**:
   - **ì¸ë±ìŠ¤ ëˆ„ë½**: `message_reactions` í…Œì´ë¸”ì— `message_id`, `user_id` ì»¬ëŸ¼ì— ëŒ€í•œ ê°œë³„ ì¸ë±ìŠ¤ê°€ ì—†ì–´ ì¡°íšŒ ì„±ëŠ¥ì´ ì €í•˜ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
   - **N+1 ë¬¸ì œ**: `getMessageReactions` í•¨ìˆ˜ê°€ ë©”ì‹œì§€ë§ˆë‹¤ ê°œë³„ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•˜ë¯€ë¡œ, ì—¬ëŸ¬ ë©”ì‹œì§€ ì¡°íšŒ ì‹œ ì„±ëŠ¥ ì´ìŠˆê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

4. **UX ì„¸ë¶€ ì‚¬í•­ ë¯¸êµ¬í˜„**:
   - ë¦¬ì•¡ì…˜ ì‚¬ìš©ì ëª©ë¡ ëª¨ë‹¬
   - ì¤‘ë³µ í´ë¦­ ë°©ì§€ ë¡œì§
   - ì—ëŸ¬ ì¼€ì´ìŠ¤ë³„ ëª…í™•í•œ ì‚¬ìš©ì í”¼ë“œë°±

5. **ë¬¸ì„œí™” ë¶€ì¡±**: ì£¼ìš” í•¨ìˆ˜ì™€ ë¡œì§ì— ëŒ€í•œ JSDoc ì£¼ì„ì´ ê±°ì˜ ì—†ì–´ ìœ ì§€ë³´ìˆ˜ì„±ì´ ë‚®ìŠµë‹ˆë‹¤.

### ê¶Œì¥ ì‚¬í•­

**ìš°ì„ ìˆœìœ„ 1 (í•„ìˆ˜)**:
1. í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„± (íŠ¹íˆ toggleReaction ì„œë¹„ìŠ¤ í•¨ìˆ˜)
2. í”„ë¡ íŠ¸ì—”ë“œ ì—ëŸ¬ í•¸ë“¤ë§ ë³´ì™„ (onError, ë¡¤ë°± ë¡œì§, í† ìŠ¤íŠ¸ ë©”ì‹œì§€)
3. DB ì¸ë±ìŠ¤ ì¶”ê°€ (`CREATE INDEX idx_message_reactions_message ON message_reactions(message_id)`, `CREATE INDEX idx_message_reactions_user ON message_reactions(user_id)`)

**ìš°ì„ ìˆœìœ„ 2 (ì¤‘ìš”)**:
4. GET ë¦¬ì•¡ì…˜ ëª©ë¡ ì¡°íšŒ ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„
5. N+1 ì¿¼ë¦¬ ìµœì í™” (ë°°ì¹˜ ì¡°íšŒ ë˜ëŠ” JOIN í™œìš©)
6. ì£¼ìš” í•¨ìˆ˜ JSDoc ì£¼ì„ ì¶”ê°€

**ìš°ì„ ìˆœìœ„ 3 (ê°œì„ )**:
7. ë¦¬ì•¡ì…˜ ì‚¬ìš©ì ëª©ë¡ ëª¨ë‹¬ UI êµ¬í˜„
8. ì¤‘ë³µ í´ë¦­ ë°©ì§€ ë¡œì§ ëª…í™•í™”
9. DELETE ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ (spec ì¼ì¹˜ ì—¬ë¶€ì— ë”°ë¼ ì„ íƒ)

---

## êµ¬í˜„ í•„ìš” í•­ëª© ìƒì„¸

### 1. í…ŒìŠ¤íŠ¸ ì½”ë“œ (í•„ìˆ˜)

**íŒŒì¼ ê²½ë¡œ**: `src/features/chat-room/backend/service.test.ts`

**í•„ìš” í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤**:
- ì •ìƒ íë¦„: ë¦¬ì•¡ì…˜ ì¶”ê°€ ì„±ê³µ
- ì •ìƒ íë¦„: ë¦¬ì•¡ì…˜ ì œê±° ì„±ê³µ (í† ê¸€)
- ì—ëŸ¬ ì¼€ì´ìŠ¤: ì‚­ì œëœ ë©”ì‹œì§€ì— ë¦¬ì•¡ì…˜ ì‹œë„
- ì—ëŸ¬ ì¼€ì´ìŠ¤: ê¶Œí•œ ì—†ëŠ” ì‚¬ìš©ì
- ì—ëŸ¬ ì¼€ì´ìŠ¤: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë©”ì‹œì§€
- Edge Case: ë™ì‹œ ë¦¬ì•¡ì…˜ ìš”ì²­ ì²˜ë¦¬

### 2. í”„ë¡ íŠ¸ì—”ë“œ ì—ëŸ¬ í•¸ë“¤ë§ (í•„ìˆ˜)

**íŒŒì¼ ê²½ë¡œ**: `src/features/chat-room/hooks/useToggleReaction.ts`

**êµ¬í˜„ ë‚´ìš©**:
```typescript
return useMutation({
  mutationFn: async (request: ToggleReactionRequest) => { ... },
  onMutate: async (request) => {
    // ë‚™ê´€ì  ì—…ë°ì´íŠ¸ ë¡œì§
    // ê¸°ì¡´ ìƒíƒœ ìŠ¤ëƒ…ìƒ· ì €ì¥
  },
  onError: (error, request, context) => {
    // ì´ì „ ìƒíƒœë¡œ ë¡¤ë°±
    // ì‚¬ìš©ìì—ê²Œ ì—ëŸ¬ í† ìŠ¤íŠ¸ í‘œì‹œ
  },
  onSuccess: (data) => { ... },
});
```

### 3. DB ì¸ë±ìŠ¤ ì¶”ê°€ (í•„ìˆ˜)

**íŒŒì¼ ê²½ë¡œ**: `supabase/migrations/0003_add_message_reactions_indexes.sql`

**ë‚´ìš©**:
```sql
CREATE INDEX IF NOT EXISTS idx_message_reactions_message
ON message_reactions(message_id);

CREATE INDEX IF NOT EXISTS idx_message_reactions_user
ON message_reactions(user_id);
```

### 4. GET ë¦¬ì•¡ì…˜ ëª©ë¡ ì¡°íšŒ ì—”ë“œí¬ì¸íŠ¸ (ì¤‘ìš”)

**íŒŒì¼ ê²½ë¡œ**: `src/features/chat-room/backend/route.ts`, `service.ts`

**ì—”ë“œí¬ì¸íŠ¸**: `GET /api/messages/:messageId/reactions`

**ì‘ë‹µ í˜•ì‹** (spec.md:274-297):
```json
{
  "success": true,
  "data": {
    "reactions": [
      {
        "type": "like",
        "count": 5,
        "users": [
          {
            "userId": "uuid",
            "nickname": "ê¹€ë¯¼ì¤€",
            "profileImageUrl": "https://picsum.photos/200"
          }
        ]
      }
    ]
  }
}
```

**í•¨ìˆ˜ ì—­í• **:
- `getReactionUsers(client, messageId)`: ë©”ì‹œì§€ì˜ ëª¨ë“  ë¦¬ì•¡ì…˜ê³¼ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
