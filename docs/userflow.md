# 사용자 흐름 정의

## 1. 회원가입
### 입력
- 사용자가 회원가입 화면에서 이메일, 비밀번호, 닉네임을 순차적으로 입력한다.
- 비밀번호 확인, 서비스 약관 및 필수 동의 항목을 체크한다.
- 가입 제출 버튼을 클릭하거나 단축키로 전송한다.
### 처리
- 클라이언트가 미입력 필드, 이메일 형식, 비밀번호 정책을 선검증하고 부족한 항목을 즉시 안내한다.
- 서버가 이메일 중복, 계정 상태(비활성·탈퇴)와 비밀번호 정책 준수 여부를 재검증한다.
- 모든 검증이 통과되면 비밀번호를 해싱하고 사용자 레코드와 기본 프로필 데이터를 트랜잭션으로 생성한다.
- 엣지 케이스 대응: 네트워크 타임아웃 시 재시도 가능 상태 유지, 동시에 제출된 중복 요청은 멱등 키로 차단, 이미 가입된 이메일은 신규 레코드 대신 안내 메시지를 반환한다.
### 출력
- 가입 성공 시 인증 토큰 또는 세션을 발급하고 초기 진입 화면으로 이동시킨다.
- 검증 실패나 정책 위반은 구체적 수정 지점을 표시한 뒤 입력값을 보존한다.
- 서버 오류나 통신 실패는 재시도 안내와 지원 경로를 제공한다.

## 2. 로그인
### 입력
- 사용자가 로그인 화면에서 이메일과 비밀번호를 입력한다.
- 저장된 자격 증명 자동완성 또는 자동 로그인 옵션을 선택한다.
- 로그인 버튼 클릭 또는 엔터 입력으로 요청을 전송한다.
### 처리
- 클라이언트가 이메일 형식, 비밀번호 공란 여부를 검사하고 즉시 피드백한다.
- 서버가 계정 존재 여부, 비활성화·잠금 상태, 인증 실패 횟수 제한을 확인한다.
- 비밀번호 검증이 성공하면 세션·토큰을 발급하고 동시 접속 정책과 MFA 요구 조건을 적용한다.
- 엣지 케이스 대응: 비밀번호 다회 오류 시 계정 잠금 처리, MFA 필요 시 추가 단계 생성, 네트워크 오류·중복 요청에 대해 백오프 재시도를 적용한다.
### 출력
- 인증 성공 시 목표 화면 또는 기본 홈으로 이동한다.
- 자격 증명 오류, 계정 잠금, 승인 대기 등은 상태별 안내와 복구 절차를 제공한다.
- 추가 인증 단계가 필요하면 다음 단계 화면을 노출하고 실패 시 입력 단계로 복귀시킨다.
- 서버 오류나 네트워크 문제 발생 시 재시도 또는 다른 접근 경로를 안내한다.

## 3. 새 채팅 생성
### 입력
- 사용자가 채팅 목록 화면에서 새 채팅 생성 버튼을 누른다.
- 검색 또는 선택 UI로 대상 사용자를 최소 한 명 선택한다.
- 두 명 이상 선택 시 그룹 채팅방 이름 입력 필드를 채운다.
- (선택) 초대 확인 등 보조 옵션을 설정하고 생성 요청을 전송한다.
### 처리
- 클라이언트가 사용자 선택 여부, 그룹명 입력 같은 필수 조건을 검증한다.
- 서버가 선택된 사용자의 유효성, 차단·탈퇴·권한 제한 여부를 확인한다.
- 1:1 조합이 기존에 존재하면 기존 방을 재사용하고, 그렇지 않으면 트랜잭션으로 채팅방과 참가자 레코드를 생성한다.
- 그룹 방은 고유 식별자를 생성하고 모든 참가자를 한 번에 등록한다.
- 엣지 케이스 대응: 동시 생성 충돌 시 최초 요청만 성공시키고 이후 요청에 기존 방 정보를 반환, 참여 제한 초과 시 생성 거절 및 안내, 네트워크 오류는 재시도 버튼과 상태 유지를 제공한다.
### 출력
- 생성 성공 시 새 채팅방 화면으로 이동하거나 목록 항목을 포커스한다.
- 입력 누락, 권한 문제, 중복 생성 충돌은 사유를 표시하고 입력 상태를 유지한다.
- 서버 오류나 통신 실패는 재시도 안내와 대체 연락 경로를 제공한다.

## 4. 메시지 전송 (Polling 기반 동기화)
### 입력
- 사용자가 채팅방 화면에서 메시지 입력 필드에 텍스트 또는 이모지를 입력한다.
- (선택) 파일 첨부, 이모지 선택기, 단축키를 활용한다.
- 전송 버튼 클릭 또는 단축키로 메시지를 제출한다.
### 처리
- 클라이언트가 입력 길이, 금지 패턴, 첨부 제한을 검증하고 문제 발생 시 즉시 안내한다.
- 서버가 사용자 권한, 차단 여부, 채팅방 참여 상태를 확인한다.
- 메시지를 트랜잭션으로 저장하고 첨부 파일은 업로드 완료 후 메시지와 연결한다.
- 서버는 저장 결과를 응답으로 반환하고, 클라이언트는 이후 주기적 polling 요청에 마지막 메시지 기준 정보를 포함한다.
- 엣지 케이스 대응: 네트워크 단절·타임아웃 시 임시 저장 후 재전송 옵션 제공, 중복 전송은 클라이언트 생성 ID로 멱등 처리, 파일 업로드 실패 시 메시지 전송을 보류하고 실패 사유를 안내한다.
### 출력
- 성공 시 발신자 UI에 메시지를 즉시 표시하고 입력 필드를 초기화한다.
- 다른 참여자는 다음 polling 응답에서 신규 메시지를 받아 목록과 읽음 상태를 갱신한다.
- 검증 실패나 권한 문제는 사유를 강조하고 입력 내용을 유지한다.
- 서버 오류나 통신 예외는 재시도 옵션 또는 다른 전달 경로를 노출한다.

## 5. 메시지 답장
### 입력
- 사용자가 특정 메시지를 길게 누르거나 옵션 메뉴에서 답장을 선택한다.
- 답장 대상 미리보기를 확인하며 새 메시지를 입력한다.
- (선택) 첨부 파일, 이모지, 단축키를 사용한다.
- 전송 버튼이나 단축키로 답장 메시지를 제출한다.
### 처리
- 클라이언트가 대상 메시지가 존재하고 권한이 있는지 확인, 삭제 또는 접근 불가 시 즉시 경고한다.
- 입력 검증 후 `reply_to` 식별자를 포함해 서버에 요청을 전달한다.
- 서버가 사용자 권한, 채팅방 참여 여부, 대상 메시지 유효성을 검사한다.
- 메시지를 트랜잭션으로 저장하고 원본 메시지 참조를 유지한 채 응답으로 메타데이터를 반환한다.
- 엣지 케이스 대응: 대상 메시지 삭제·권한 변경 시 실패 사유 반환, 중복 요청은 멱등 처리, 네트워크 오류 시 재시도 안내 제공.
### 출력
- 성공 시 답장 구조를 포함한 메시지가 발신자 화면에 표시되고 입력 필드가 초기화된다.
- 수신자는 다음 polling 결과에서 답장 관계가 포함된 메시지를 렌더링한다.
- 실패 시 원인 안내와 함께 입력 내용을 유지하고 수정 유도한다.
- 서버 또는 네트워크 오류는 재시도 버튼이나 다른 지원 경로를 노출한다.

## 6. 메시지 리액션
### 입력
- 사용자가 메시지를 길게 누르거나 옵션 메뉴를 열어 리액션 기능을 선택한다.
- 제공된 리액션 중 하나를 선택하거나 기존 선택을 해제한다.
- (선택) 다른 메시지에도 연속으로 리액션을 시도한다.
### 처리
- 클라이언트가 메시지 표시 가능 상태와 권한을 확인하고, 삭제·차단 시 즉시 안내한다.
- 선택된 리액션 타입과 메시지 ID를 서버로 전송한다.
- 서버가 사용자 권한, 채팅방 참여 여부, 메시지 존재 여부를 검증한다.
- 동일 사용자의 동일 메시지 리액션 존재 여부를 확인해 추가 또는 제거를 결정하고 트랜잭션으로 처리한다.
- 엣지 케이스 대응: 동시 요청 시 잠금·멱등 처리로 카운트 불일치를 방지, 권한 상실 시 거절 응답, 네트워크 오류는 로컬 상태 복원과 재시도를 안내한다.
### 출력
- 성공 시 해당 메시지의 리액션 아이콘과 카운트가 즉시 갱신된다.
- 다른 참여자는 이후 polling 응답에서 갱신된 리액션 정보를 반영한다.
- 권한 부족, 메시지 미존재, 리액션 제한은 안내 메시지와 함께 이전 상태를 유지한다.
- 서버 오류나 통신 실패 시 재시도 옵션 또는 지원 경로를 제공한다.

## 7. 메시지 삭제
### 입력
- 사용자가 자신이 보낸 메시지의 옵션 메뉴를 열어 삭제 기능을 선택한다.
- 필요 시 확인 모달에서 삭제 의사를 재확인한다.
- (선택) 삭제 후에도 입력 필드에서 추가 메시지를 준비한다.
### 처리
- 클라이언트가 메시지 소유자 여부와 삭제 진행 중 여부를 확인한다.
- 서버에 메시지 ID와 사용자 ID를 포함한 삭제 요청을 전송한다.
- 서버가 메시지 존재, 소유권, 참여 상태를 검증한다.
- 검증 통과 시 `is_deleted`를 true로 업데이트하고 콘텐츠를 비우는 작업을 트랜잭션으로 수행한다.
- 엣지 케이스 대응: 이미 삭제된 메시지는 멱등 응답을 반환, 동시 삭제 요청은 최초 성공만 인정, 네트워크 실패 시 상태 롤백과 재시도 안내를 제공한다.
### 출력
- 성공 시 메시지가 삭제 상태로 표시되고 입력 필드는 기존 내용을 유지한다.
- 다른 참여자도 다음 polling에서 동일한 삭제 상태를 확인한다.
- 권한 부족이나 메시지 미존재는 안내 후 원본 메시지를 유지한다.
- 서버 오류나 통신 문제는 재시도 안내와 지원 경로를 제공한다.

## 8. 채팅 목록 조회
### 입력
- 사용자가 로그인 후 채팅 목록 화면으로 진입하거나 상단 탭에서 목록을 재진입한다.
- (선택) 검색, 필터, 정렬 옵션을 적용한다.
- 수동 새로고침 버튼을 누르거나 자동 갱신 주기를 기다린다.
- 특정 채팅방 항목을 선택해 상세 화면으로 이동한다.
### 처리
- 클라이언트가 로그인 세션을 확인하고 초기 목록 요청을 보낸다.
- 서버가 참여 채팅방을 최신 메시지 정보, 읽지 않은 메시지 수와 함께 반환한다.
- 클라이언트는 데이터를 렌더링하고 미리보기와 타임스탬프를 표시한다.
- 일정 주기로 polling 요청을 보내 변경된 채팅방 정보를 갱신하고 삭제된 방은 목록에서 제거한다.
- 엣지 케이스 대응: 권한 만료 시 재인증 요구, 데이터 충돌 시 최신 타임스탬프 기준으로 병합, 네트워크 실패 시 로컬 캐시를 유지하며 재시도를 예약한다.
### 출력
- 최신 메시지 기준으로 정렬된 목록이 표시되고, 새 메시지가 있는 방은 즉시 갱신된다.
- 검색·필터·정렬 조건에 따라 결과가 갱신된다.
- 항목 선택 시 해당 채팅방으로 이동하고 이전 스크롤 위치를 저장한다.
- 오류 발생 시 문제 유형별 안내와 재시도 또는 로그아웃 유도를 제공한다.

## 9. 채팅방 진입 및 메시지 동기화
### 입력
- 사용자가 채팅 목록에서 채팅방을 선택하거나 알림을 통해 진입한다.
- 과거 메시지를 보기 위해 스크롤을 위로 이동하거나 더 보기 버튼을 누른다.
- (선택) 수동 새로고침으로 최신 메시지 동기화를 시도한다.
- (선택) 짧은 시간 내 다른 채팅방으로 이동하거나 되돌아온다.
### 처리
- 클라이언트가 마지막으로 본 메시지 ID·타임스탬프를 기준으로 초기 메시지 요청을 보낸다.
- 서버가 참여 권한을 검증하고 최신 메시지, 읽음 정보, 리액션, 답장 메타데이터를 반환한다.
- 클라이언트는 응답을 시간 순으로 렌더링하고 읽지 않은 메시지 경계를 표시한다.
- 일정 주기의 polling으로 신규 메시지, 삭제 상태, 리액션 변경을 조회해 기존 데이터와 병합한다.
- 무한 스크롤 요청 시 서버는 페이지네이션으로 과거 메시지를 반환하고 더 이상 없으면 종료 신호를 제공한다.
- 엣지 케이스 대응: 네트워크 중단 시 로컬 캐시를 유지하고 재시도, 중복 응답은 메시지 ID 기준으로 제거, 권한 상실 시 즉시 채팅방에서 이탈시키고 안내한다.
### 출력
- 진입 시 최신 메시지와 읽지 않은 구간이 명확히 표시된다.
- 과거 메시지를 성공적으로 불러오면 스크롤 위치를 유지한 채 탐색할 수 있다.
- polling 업데이트로 신규 메시지와 상태 변경이 실시간에 가깝게 반영된다.
- 오류 발생 시 유형별 안내와 재시도 또는 다른 채팅방 이동 옵션을 제공한다.
